# OpenAI Proxy

Легкий прокси-сервер на Go, который пересылает запросы к OpenAI-совместимым API и сохраняет логи запросов и ответов в PostgreSQL. Через веб-интерфейс `/admin/logs` можно:

- Добавлять правила прокси (`локальный путь -> upstream URL`).
- Смотреть список последних запросов и открывать детали.

## Настройка

1. Установите переменные окружения:
   - `APP_LISTEN_ADDR` – адрес HTTP-сервера (по умолчанию `:8080`).
   - `UPSTREAM_URL` – (опционально) базовый URL целевого API. Если указано, при первом запуске создаётся правило `/ -> UPSTREAM_URL`.
   - `UPSTREAM_API_KEY` – (опционально) ключ авторизации, который будет использован для дефолтного правила.
   - `DATABASE_URL` – строка подключения PostgreSQL (формат `postgres://user:pass@host:port/dbname`).
   - `USD_RUB_RATE` – курс перевода доллара в рубли, используется для расчёта стоимости токенов (по умолчанию `90`).

2. Запустите сервер:

```bash
go run ./cmd/server
```

Таблица `api_logs` создаётся автоматически.

## Веб-интерфейс

Страница `/admin/logs` совмещает админку и мониторинг:

- Форма «Правила проксирования» — впишите, например, путь `/openai` и upstream `https://api.openai.com/v1`. Для расчётов задаются отдельные тарифы `$ / 1M` токенов для входящих (input) и исходящих (output) данных; ключ при необходимости также сохранится и будет автоматически подставляться.
- Таблица маршрутов показывает активные правила, накопленные input/output токены и стоимость в USD и RUB. Для каждого правила можно обновить обе цены и сбросить счётчик (начать расчёт заново с текущего момента).
- Блок логов отображает последние запросы с разбивкой по input/output токенам и стоимости. Можно раскрыть детали отдельной записи.

Дополнительно доступны JSON-эндпоинты:

- `GET /admin/api/proxies` — список настроенных правил + агрегированная статистика.
- `POST /admin/api/proxies` — добавить правило (тот же формат, что и в форме).
- `PATCH /admin/api/proxies/{id}` — изменить тарифы (и/или имя/ключ) для правила.
- `POST /admin/api/proxies/{id}/reset` — сбросить накопленные токены/стоимость по правилу.
- `GET /admin/api/logs?limit=50` — последние логи.
- `GET /admin/logs/{id}` — детали конкретного лога (JSON).

## Ограничения

- Прокси считывает весь ответ в память, поэтому для очень больших потоков потребуется доработка (например, стриминг с параллельной записью).
- Подсчёт токенов основан на разбиении текста по пробелам, поэтому носит оценочный характер. Для строгого соответствия токенизатору поставщика необходима дальнейшая интеграция.
- Для защиты персональных данных заголовок `Authorization` в сохранённом запросе маскируется.
