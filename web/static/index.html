<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>API Proxy Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
      #details {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .timestamp {
        color: #555;
        font-size: 0.9em;
      }
      .error {
        color: #b30000;
        font-weight: bold;
      }
      .help-text {
        font-size: 0.85em;
        color: #666;
        margin-top: 4px;
      }
      .card {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      }
      .chart-box {
        height: 320px;
      }
    </style>
  </head>
  <body class="container py-4">
    <header
      class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3"
    >
      <div>
        <h1 class="mb-1">Панель управления прокси</h1>
        <p class="text-muted mb-0">
          Автообновление логов и графиков включается прямо здесь. Добавление
          новых правил вынесено в отдельную страницу.
        </p>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" href="/admin/rules"
          >Добавить правило</a
        >
        <button id="manual-refresh" class="btn btn-secondary">
          Обновить всё
        </button>
      </div>
    </header>

    <section class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h2 class="mb-0">Правила проксирования</h2>
          <p class="text-muted mb-0">
            Редактируйте цены и ключи, добавление новых правил доступно по
            кнопке «Добавить правило».
          </p>
        </div>
        <span class="badge text-bg-light">Настройки</span>
      </div>

      <div class="alert alert-info" id="usage-summary"></div>

      <div class="table-responsive card p-3">
        <table
          id="proxies-table"
          class="table table-striped table-hover align-middle mb-0"
        >
          <thead class="table-dark">
            <tr>
              <th>Путь</th>
              <th>Имя</th>
              <th>Upstream</th>
              <th>API Key</th>
              <th>Цена input $ / 1M</th>
              <th>Цена cached input $ / 1M</th>
              <th>Цена output $ / 1M</th>
              <th>Input токены</th>
              <th>Output токены</th>
              <th>USD input</th>
              <th>USD output</th>
              <th>USD total</th>
              <th>RUB input</th>
              <th>RUB output</th>
              <th>RUB total</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h2 class="mb-0">Логи запросов</h2>
          <p class="text-muted mb-0">
            Автообновление последних запросов работает по выбранному интервалу.
          </p>
        </div>
        <div class="text-end">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="logs-auto"
              checked
            />
            <label class="form-check-label" for="logs-auto"
              >Автообновление</label
            >
          </div>
          <small id="logs-status" class="text-muted d-block"></small>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-auto">
          <label for="limit" class="form-label">Показать последние</label>
          <input
            type="number"
            id="limit"
            class="form-control"
            value="10"
            min="1"
            max="500"
          />
        </div>
        <div class="col-auto">
          <label for="logs-interval" class="form-label">Интервал, сек</label>
          <input
            type="number"
            id="logs-interval"
            class="form-control"
            value="10"
            min="2"
            max="300"
          />
        </div>
        <div class="col-auto d-flex align-items-end">
          <button id="refresh" class="btn btn-secondary">Обновить логи</button>
        </div>
      </div>

      <div class="table-responsive card p-3">
        <table
          id="logs-table"
          class="table table-striped table-hover align-middle mb-0"
        >
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Timestamp</th>
              <th>Proxy</th>
              <th>Method</th>
              <th>Path</th>
              <th>Status</th>
              <th>Tokens in</th>
              <th>Tokens out</th>
              <th>USD in</th>
              <th>USD out</th>
              <th>USD total</th>
              <th>RUB in</th>
              <th>RUB out</th>
              <th>RUB total</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h2 class="mb-0">Статистика</h2>
          <p class="text-muted mb-0">
            Графики на основе Apache ECharts с поддержкой zoom и подсказок.
          </p>
        </div>
        <div class="text-end">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="stats-auto"
              checked
            />
            <label class="form-check-label" for="stats-auto"
              >Автообновление</label
            >
          </div>
          <small id="stats-status" class="text-muted d-block"></small>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-auto">
          <label for="stats-period" class="form-label">Период</label>
          <select id="stats-period" class="form-control">
            <option value="hour">По часам</option>
            <option value="day">По дням</option>
            <option value="week">По неделям</option>
          </select>
        </div>
        <div class="col-auto">
          <label for="stats-limit" class="form-label">Количество точек</label>
          <input
            type="number"
            id="stats-limit"
            class="form-control"
            value="24"
            min="1"
            max="200"
          />
        </div>
        <div class="col-auto">
          <label for="stats-interval" class="form-label">Интервал, сек</label>
          <input
            type="number"
            id="stats-interval"
            class="form-control"
            value="30"
            min="5"
            max="600"
          />
        </div>
        <div class="col-auto d-flex align-items-end">
          <button id="load-stats" class="btn btn-secondary">
            Обновить графики
          </button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <div id="requestsChart" class="chart-box card"></div>
        </div>
        <div class="col-md-6">
          <div id="tokensChart" class="chart-box card"></div>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <div id="costUSDChart" class="chart-box card"></div>
        </div>
        <div class="col-md-6">
          <div id="costRUBChart" class="chart-box card"></div>
        </div>
      </div>
    </section>

    <h2 class="mb-3">Детали</h2>
    <pre id="details" class="bg-light p-3 border rounded">
Выберите запись, чтобы увидеть детали запроса и ответа.</pre
    >

    <script>
      const charts = {};
      let logsAutoTimer = null;
      let statsAutoTimer = null;

      async function loadProxies() {
        const response = await fetch("/admin/api/proxies");
        if (!response.ok) {
          console.error("Failed to load proxies");
          return;
        }
        const data = await response.json();
        const tbody = document.querySelector("#proxies-table tbody");
        tbody.innerHTML = "";
        data.proxies.forEach((proxy) => {
          const tr = document.createElement("tr");
          tr.dataset.proxyId = proxy.id;
          tr.innerHTML = `
            <td>${proxy.path_prefix}</td>
            <td>${proxy.name || ""}</td>
            <td>${proxy.upstream_url}</td>
            <td>
                <input type="password" class="form-control form-control-sm key-input" placeholder="Новый API Key" />
                <button class="btn btn-sm btn-secondary ms-2 save-key">Сохранить Key</button>
            </td>
            <td>
                $${Number(proxy.token_price_input_usd || 0).toFixed(2)}
            </td>
            <td>
                $${Number(proxy.token_price_cached_input_usd || 0).toFixed(2)}
            </td>
            <td>
                $${Number(proxy.token_price_output_usd || 0).toFixed(2)}
            </td>
             <td>${formatNumber(proxy.usage_input_tokens)}</td>
             <td>${formatNumber(proxy.usage_output_tokens)}</td>
             <td>${Number(proxy.usage_input_cost_usd || 0).toFixed(4)}</td>
             <td>${Number(proxy.usage_output_cost_usd || 0).toFixed(4)}</td>
             <td>${Number((proxy.usage_input_cost_usd || 0) + (proxy.usage_output_cost_usd || 0)).toFixed(4)}</td>
             <td>${Number(proxy.usage_input_cost_rub || 0).toFixed(2)}</td>
             <td>${Number(proxy.usage_output_cost_rub || 0).toFixed(2)}</td>
            <td>${Number((proxy.usage_input_cost_rub || 0) + (proxy.usage_output_cost_rub || 0)).toFixed(2)}</td>
            <td>
                <a class="btn btn-sm btn-info me-1" href="/admin/rules/edit?id=${proxy.id}">Редактировать</a>
                <button class="btn btn-sm btn-warning me-1 reset-usage">Сбросить</button>
                <button class="btn btn-sm btn-danger delete-proxy">Удалить</button>
            </td>
        `;
          tbody.appendChild(tr);
        });

        document.querySelectorAll(".save-key").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const row = event.target.closest("tr");
            const id = row.dataset.proxyId;
            const keyInput = row.querySelector(".key-input");
            const key = keyInput.value;
            await updateProxyKey(id, key);
            keyInput.value = "";
          });
        });

        document.querySelectorAll(".reset-usage").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const row = event.target.closest("tr");
            const id = row.dataset.proxyId;
            if (!confirm("Сбросить накопленную статистику по токенам?")) {
              return;
            }
            await resetProxyUsage(id);
            await loadProxies();
          });
        });

        document.querySelectorAll(".delete-proxy").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const row = event.target.closest("tr");
            const id = row.dataset.proxyId;
            if (!confirm("Удалить прокси и связанные логи?")) {
              return;
            }
            await deleteProxy(id);
            await loadProxies();
          });
        });

        const summary = document.getElementById("usage-summary");
        summary.innerHTML =
          `<strong>Общая статистика:</strong> Input: ${formatNumber(data.total_input_tokens)} токенов, $${Number(data.total_input_cost_usd || 0).toFixed(4)} / ₽${Number(data.total_input_cost_rub || 0).toFixed(2)}; ` +
          `Output: ${formatNumber(data.total_output_tokens)} токенов, $${Number(data.total_output_cost_usd || 0).toFixed(4)} / ₽${Number(data.total_output_cost_rub || 0).toFixed(2)}`;
      }

      async function updateProxyKey(id, key) {
        const response = await fetch(`/admin/api/proxies/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            upstream_key: key,
          }),
        });
        if (!response.ok) {
          const message = await response.text();
          alert(`Не удалось обновить API Key: ${message}`);
        }
      }

      async function resetProxyUsage(id) {
        const response = await fetch(`/admin/api/proxies/${id}/reset`, {
          method: "POST",
        });
        if (!response.ok) {
          const message = await response.text();
          alert(`Не удалось сбросить статистику: ${message}`);
        }
      }

      async function deleteProxy(id) {
        const response = await fetch(`/admin/api/proxies/${id}`, {
          method: "DELETE",
        });
        if (!response.ok) {
          const message = await response.text();
          alert(`Не удалось удалить прокси: ${message}`);
        }
      }

      async function loadLogs() {
        const limitInput = document.getElementById("limit");
        const limit = parseInt(limitInput.value, 10) || 50;
        const response = await fetch(`/admin/api/logs?limit=${limit}`);
        if (!response.ok) {
          alert("Failed to load logs");
          return;
        }
        const logs = await response.json();
        const tbody = document.querySelector("#logs-table tbody");
        tbody.innerHTML = "";
        logs.forEach((log) => {
          const tr = document.createElement("tr");
          tr.addEventListener("click", () => loadDetails(log.id));
          tr.innerHTML = `
            <td>${log.id}</td>
            <td class="timestamp">${new Date(log.created_at).toLocaleString()}</td>
            <td>${log.proxy_name || log.proxy_path_prefix || ""}</td>
            <td>${log.method}</td>
            <td>${log.path}${log.query ? "?" + log.query : ""}</td>
            <td>${log.response_status}</td>
             <td>${formatNumber(log.request_tokens)}</td>
             <td>${formatNumber(log.response_tokens)}</td>
            <td>${Number(log.cost_input_usd || 0).toFixed(4)}</td>
            <td>${Number(log.cost_output_usd || 0).toFixed(4)}</td>
            <td>${Number(log.cost_total_usd || 0).toFixed(4)}</td>
            <td>${Number(log.cost_input_rub || 0).toFixed(2)}</td>
            <td>${Number(log.cost_output_rub || 0).toFixed(2)}</td>
            <td>${Number(log.cost_total_rub || 0).toFixed(2)}</td>
            <td class="error">${log.error_message || ""}</td>
        `;
          tbody.appendChild(tr);
        });
        markUpdated("logs-status");
      }

      async function loadDetails(id) {
        const response = await fetch(`/admin/logs/${id}`);
        if (!response.ok) {
          alert("Failed to load log details");
          return;
        }
        const log = await response.json();
        const details = document.getElementById("details");
        const requestBody =
          log.request_body !== null
            ? formatJSON(decodeBase64Utf8(log.request_body))
            : "";
        const responseBody =
          log.response_body !== null
            ? formatJSON(decodeBase64Utf8(log.response_body))
            : "";
        details.innerHTML = `<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#request" type="button" role="tab" aria-selected="true">Request</button></li><li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#response" type="button" role="tab" aria-selected="false">Response</button></li></ul><div class="tab-content mt-3"><div class="tab-pane fade show active" id="request" role="tabpanel">ID: ${log.id}<br>Time: ${new Date(log.created_at).toLocaleString()}<br>Proxy: ${log.proxy_name || log.proxy_path_prefix || ""}<br>Method: ${log.method}<br>Path: ${log.path}${log.query ? "?" + log.query : ""}<br>Request tokens: ${formatNumber(log.request_tokens)}<br>Cost input: $${Number(log.cost_input_usd || 0).toFixed(4)} / ₽${Number(log.cost_input_rub || 0).toFixed(2)}<br><br>Request Headers:<br>${log.request_headers.replace(/\n/g, "<br>")}<br><br>Request Body:<br><pre><code class="language-json">${requestBody}</code></pre></div><div class="tab-pane fade" id="response" role="tabpanel">Status: ${log.response_status}<br>Error: ${log.error_message}<br>Response tokens: ${formatNumber(log.response_tokens)}<br>Total tokens: ${formatNumber(log.total_tokens)}<br>Cost output: $${Number(log.cost_output_usd || 0).toFixed(4)} / ₽${Number(log.cost_output_rub || 0).toFixed(2)}<br>Cost total: $${Number(log.cost_total_usd || 0).toFixed(4)} / ₽${Number(log.cost_total_rub || 0).toFixed(2)}<br><br>Response Headers:<br>${log.response_headers.replace(/\n/g, "<br>")}<br><br>Response Body:<br><pre><code class="language-json">${responseBody}</code></pre></div></div>`;
        hljs.highlightAll();
      }

      function decodeBase64Utf8(base64) {
        const bytes = Uint8Array.from(atob(base64), (c) => c.charCodeAt(0));
        return new TextDecoder("utf-8").decode(bytes);
      }

      function formatJSON(text) {
        try {
          const parsed = JSON.parse(text);
          return JSON.stringify(parsed, null, 2);
        } catch (e) {
          return text;
        }
      }

      function formatNumber(num) {
        return new Intl.NumberFormat("ru-RU").format(num);
      }

      async function loadStats() {
        const period = document.getElementById("stats-period").value;
        const limit = document.getElementById("stats-limit").value;

        const response = await fetch(
          `/admin/api/stats?period=${period}&limit=${limit}`,
        );
        if (!response.ok) {
          console.error("Failed to load stats");
          return;
        }
        const stats = await response.json();
        renderCharts(stats.reverse());
        markUpdated("stats-status");
      }

      function renderCharts(stats) {
        const labels = stats.map((point) =>
          new Date(point.time).toLocaleString(),
        );

        const requestsData = stats.map((point) => point.request_count);
        const tokensData = stats.map((point) => point.total_tokens);
        const costUSDData = stats.map((point) => point.cost_total_usd);
        const costRUBData = stats.map((point) => point.cost_total_rub);

        renderLineChart(
          "requestsChart",
          "Количество запросов",
          labels,
          requestsData,
        );
        renderLineChart("tokensChart", "Всего токенов", labels, tokensData);
        renderLineChart(
          "costUSDChart",
          "Стоимость USD",
          labels,
          costUSDData,
          "rgb(255, 205, 86)",
        );
        renderLineChart(
          "costRUBChart",
          "Стоимость RUB",
          labels,
          costRUBData,
          "rgb(255, 99, 132)",
        );
      }

      function renderLineChart(domId, seriesName, labels, data, color) {
        const element = document.getElementById(domId);
        if (!charts[domId]) {
          charts[domId] = echarts.init(element);
        }
        charts[domId].setOption({
          title: {
            text: seriesName,
            left: "center",
            textStyle: { fontSize: 14 },
          },
          tooltip: {
            trigger: "axis",
            valueFormatter: (value) => formatNumber(value),
          },
          toolbox: {
            feature: {
              saveAsImage: { title: "Скачать" },
              dataZoom: { title: { zoom: "Приблизить", back: "Сбросить" } },
            },
            right: 10,
          },
          grid: { left: 60, right: 20, bottom: 60, top: 50 },
          dataZoom: [
            { type: "inside", throttle: 50 },
            { type: "slider", bottom: 10 },
          ],
          xAxis: {
            type: "category",
            data: labels,
            boundaryGap: false,
            axisLabel: { interval: "auto", rotate: 20 },
          },
          yAxis: {
            type: "value",
            axisLabel: {
              formatter: (value) => formatNumber(value),
            },
          },
          series: [
            {
              name: seriesName,
              type: "line",
              smooth: true,
              data: data,
              areaStyle: {},
              lineStyle: { width: 2, color: color || "rgb(75, 192, 192)" },
              itemStyle: { color: color || "rgb(75, 192, 192)" },
            },
          ],
        });
      }

      function markUpdated(statusId) {
        const el = document.getElementById(statusId);
        el.textContent = `Обновлено: ${new Date().toLocaleTimeString()}`;
      }

      function startLogsAuto() {
        stopLogsAuto();
        const intervalSec = parseInt(
          document.getElementById("logs-interval").value,
          10,
        );
        const autoEnabled = document.getElementById("logs-auto").checked;
        if (!autoEnabled || Number.isNaN(intervalSec) || intervalSec < 2) {
          document.getElementById("logs-status").textContent =
            "Автообновление выключено";
          return;
        }
        logsAutoTimer = setInterval(loadLogs, intervalSec * 1000);
        document.getElementById("logs-status").textContent =
          `Автообновление каждые ${intervalSec} сек`;
      }

      function stopLogsAuto() {
        if (logsAutoTimer) {
          clearInterval(logsAutoTimer);
          logsAutoTimer = null;
        }
      }

      function startStatsAuto() {
        stopStatsAuto();
        const intervalSec = parseInt(
          document.getElementById("stats-interval").value,
          10,
        );
        const autoEnabled = document.getElementById("stats-auto").checked;
        if (!autoEnabled || Number.isNaN(intervalSec) || intervalSec < 5) {
          document.getElementById("stats-status").textContent =
            "Автообновление выключено";
          return;
        }
        statsAutoTimer = setInterval(loadStats, intervalSec * 1000);
        document.getElementById("stats-status").textContent =
          `Автообновление каждые ${intervalSec} сек`;
      }

      function stopStatsAuto() {
        if (statsAutoTimer) {
          clearInterval(statsAutoTimer);
          statsAutoTimer = null;
        }
      }

      document.getElementById("refresh").addEventListener("click", () => {
        loadLogs();
      });
      document.getElementById("load-stats").addEventListener("click", () => {
        loadStats();
      });
      document
        .getElementById("manual-refresh")
        .addEventListener("click", () => {
          loadProxies();
          loadLogs();
          loadStats();
        });

      document
        .getElementById("logs-auto")
        .addEventListener("change", startLogsAuto);
      document
        .getElementById("logs-interval")
        .addEventListener("change", startLogsAuto);
      document
        .getElementById("stats-auto")
        .addEventListener("change", startStatsAuto);
      document
        .getElementById("stats-interval")
        .addEventListener("change", startStatsAuto);

      window.addEventListener("resize", () => {
        Object.values(charts).forEach((chart) => chart.resize());
      });

      loadProxies();
      loadLogs().then(startLogsAuto);
      loadStats().then(startStatsAuto);
    </script>
  </body>
</html>
